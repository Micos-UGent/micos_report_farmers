---
title: "Verslag microplastic analyse MiCoS"
subtitle: "Perceel `r params$FieldID`"
author:
  - name: "Prof. Caroline De Tender"
    affiliation: "Universiteit Gent"
  - name: "dr. Lisa Joos"
    affiliation: "Universiteit Gent"
email: "micos@ugent.be"
output: 
  prettydoc::html_pretty: 
    theme: leonids
    highlight: github
params:
  FieldID: "MC24_008"
---

![](figures/logo_micos.png){width=20%}

```{r, include = FALSE}
# Algemene informatie gebruik script
# Alle chuncks met code mogen niet voorkomen in het script, daarom moeten deze include = FALSE zijn. 

```

```{r, include = FALSE}
# Deze pakketten zijn nodig om het script te laten lopen.
library(dplyr)
library(tidyr)
library(gt)
# Optioneel: gtExtras voor nette databalken
# install.packages("gtExtras") # indien nodig
library(gtExtras)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(dplyr)
library(kableExtra)
```

**To add:**

+ GPS coordinaten
+ bodemtextuur
+ APARTE NUTRIENTEN RESULTATEN PER PLOT?
+ macroplastics data?

Beste landbouwer,

In dit verslag vindt u de resultaten van het **MiCoS‑onderzoek** op uw perceel waaraan u hebt deelgenomen. Het MiCoS onderzoek is uitgevoerd in opdracht van Universiteit Gent om de microplastic concentratie in landbouwgronden van België, Nederland en Luxemburg in kaart te brengen. Deze staalname is uitgevoerd in de periode januari 2023 tem maart 2024. Hierbij zijn bodemstalen genomen voor verschillende analyses: microplastics, macroplastics, nutriënten en microbioom.

Op het veld zijn in totaal vijf stalen genomen. Voor de nutriëntenanalyse zijn drie stalen (ABC) onderzocht. Voor de microplasticanalyse zijn twee stalen (staal A en C) geanalyseerd. De macroplastic analyse is gedaan door het afval te verzamelen tussen staalname locatie A en C. Een samenvatting van de microbioomdata zal aan het einde van het MiCoS-project worden gedeeld.

**Informatie:**

-   **Microplastics** zijn kleine plasticdeeltjes van minder dan 5 mm.
-   **Macroplastics** zijn grotere stukken plastic, zoals folie of verpakkingsmateriaal.

**Disclaimer:**

-   Wij kunnen geen verdere informatie verstrekken ivm het verbeteren van de bodemgezondheid

```{r, include = FALSE}
# Locate data
path <- ("./raw_data")

# Create full pathways to necessary data files
path_nutrients <- file.path(path, "Nutrient_data.csv")
path_farmers <- file.path(path, "sampling_farmer_information.csv")
path_MP <- file.path(path, "predicted_materials_count_by_sample_plotAandC_forR.csv")

## Check if paths exists
file.exists(path_nutrients, path_farmers, path_MP)
```

```{r, include = FALSE}
# Load data
df_nutrients <- read.csv(path_nutrients, header = TRUE, sep = ";")

# Load farmer data
df_farmers <- read.csv(path_farmers, header = TRUE, sep = ";")
## There are empty rows in the excel startin with X, remove those
df_farmers <- df_farmers[, !grepl("^X", names(df_farmers))]  # Remove X, X.1, ...

# Load MP data
df_MP <- read.csv(path_MP, header = TRUE, sep = ";")

```

```{r, include = FALSE}
merged_df <- df_nutrients %>%
  left_join(df_MP, by = "FieldID_Replicate")

merged_df <- merged_df %>%
  left_join(df_farmers, by = "FieldID.x")

# Rename a single column
colnames(merged_df)[colnames(merged_df) == "FieldID.x"] <- "FieldID"

```

# ALGEMENE INFORMATIE

In dit verslag kan u de volgende resultaten terugvinden:

-   Datum van staalname: `r unique(merged_df %>% filter(FieldID == params$FieldID) %>% pull(Sampling_date))`
-   Opgegeven dichtsbijzijnde adres: `r unique(merged_df %>% filter(FieldID == params$FieldID) %>% pull(CompleteAddress))`
-   GPS coordinaten voor
    -   Plot A
    -   Plot B
    -   Plot C
-   Grondsoort:

# ANALYSERESULTATEN

## Nutriënten

In onderstaande tabel kan u de resultaten vinden van de geanalyseerde nutriënten.

```{r}

# Variabelen
vars <- c("pH_KCl", "OC", "Ntotaal", "K_AmLact", "Mg_AmLact", "Ca_AmLact", "P_AmLact")

# Meta (Parameter + Eenheid)
meta <- tibble::tribble(
  ~Variabele,   ~Parameter,               ~Eenheid,
  "Ntotaal",    "Nitraat-N",              "mg/l",
  "P_AmLact",   "Fosfor",                 "mg/l",
  "K_AmLact",   "Kalium",                 "mg/l",
  "Mg_AmLact",  "Magnesium",              "mg/l",
  "Ca_AmLact",  "Calcium",                "mg/l",
  "pH_KCl",     "Zuurgraden pH-KCl",      "",
  "OC",         "Organische stof",        "%"
)

# Samenvatting: mean en SE per variabele
summary_df <- merged_df %>%
  select(any_of(vars)) %>%
  mutate(across(everything(), ~ suppressWarnings(as.numeric(.)))) %>%
  summarise(
    across(
      everything(),
      list(
        mean = ~ mean(.x, na.rm = TRUE),
        se   = ~ { n <- sum(!is.na(.x)); if (n > 1) sd(.x, na.rm = TRUE) / sqrt(n) else NA_real_ }
      ),
      .names = "{.col}__{.fn}"
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("Variabele", "Statistiek"),
    names_sep = "__",
    values_to = "Waarde"
  ) %>%
  pivot_wider(names_from = Statistiek, values_from = Waarde) %>%
  mutate(mean = round(mean, 1),
         se   = round(se, 1)) %>%
  left_join(meta, by = "Variabele") %>%
  mutate(
    # Alleen "gemiddelde ± SE" (zonder eenheid)
    Analyse_resultaat = sprintf("%.1f \u00B1 %.1f", mean, se)
  ) %>%
  select(Variabele, Parameter, Analyse_resultaat, Eenheid)

# Replicaten: één rij per variabele met A, B, C
replicaten_df <- merged_df %>%
  select(any_of(vars)) %>%
  mutate(across(everything(), ~ suppressWarnings(as.numeric(.)))) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Variabele",
    values_to = "waarde"
  ) %>%
  filter(!is.na(waarde)) %>%
  group_by(Variabele) %>%
  summarise(
    A = if (n() >= 1) round(dplyr::nth(waarde, 1), 1) else NA_real_,
    B = if (n() >= 2) round(dplyr::nth(waarde, 2), 1) else NA_real_,
    C = if (n() >= 3) round(dplyr::nth(waarde, 3), 1) else NA_real_,
    .groups = "drop"
  )

# Finale tabel: Eenheid-kolom direct achter Analyse_resultaat
table_df <- summary_df %>%
  left_join(replicaten_df, by = "Variabele") %>%
  mutate(Variabele = factor(Variabele, levels = vars)) %>%
  arrange(Variabele) %>%
  select(Parameter, Analyse_resultaat, Eenheid, A, B, C)



```
```{r}

# 5) Kies kolommen die in de tabel moeten komen
gt_df <- table_df %>%
  dplyr::select(
    Parameter,
    Analyse_resultaat,  # bv. "6.3 ± 0.0"
    Eenheid,            # bv. "mg/l"
    A, B, C             # replicaten naast elkaar
  )

# 6) Bouw de gt-tabel
tab <- gt::gt(gt_df) %>%
  # Kopteksten
  gt::tab_header(
    title = gt::md("**ANALYSERESULTATEN**"),
    subtitle = "Samenvatting parameters"
  ) %>%
  # Labels per kolom
  gt::cols_label(
    Parameter = "Parameter",
    Analyse_resultaat = md("Gemiddeld resultaat<br>(gem. ± SE)"),
    Eenheid = "Eenheid",
    A = "A",
    B = "B",
    C = "C"
  ) %>%
  # Kolomspanner boven A/B/C
  gt::tab_spanner(
    label = "Resultaat per plot",
    columns = c(A, B, C)
  ) %>%
  # Stijl (optioneel, subtiel)
  gtExtras::gt_theme_538() %>%
  gt::fmt_markdown(columns = "Parameter") %>%
  # tabel-lijnen en opmaak
  gt::tab_options(
    table.border.top.color = "#3E7C59",
    table.border.bottom.style = "solid",
    table.border.bottom.width = gt::px(2),
    table.border.bottom.color = "#3E7C59",
    heading.background.color = "#3E7C59",
    column_labels.background.color = "#EFEFEF",
    row.striping.background_color = "#F9F9F9",
    row.striping.include_table_body = TRUE
  ) %>%
  # dunne tussenlijnen voor subtiele scheiding
  gt::tab_style(
    style = gt::cell_borders(sides = "bottom", color = "#A8D5A2", weight = gt::px(1)),
    locations = gt::cells_body(columns = gt::everything())
  )


# Optie B: binnen R Markdown naar PDF (LaTeX)
# Zet in een Rmd-chunk (zonder echo) dit neer:
cat(gt::as_latex(tab))

```

```{r results='asis', echo=FALSE, warning=FALSE, message=FALSE}
# Zet gt-object om naar LaTeX en schrijf inline naar de PDF
latex_tab <- gt::as_latex(tab)
cat(latex_tab)

```


```{r}

```




## Microplastic 


```{r eval = FALSE, echo = FALSE}


# 1) Select the columns
kable_df <- table_df %>%
  select(Parameter,
         Analyse_resultaat,
         Streeftraject_txt,
         score,
         in_streef) %>%
  mutate(
    # Convert logical TRUE/FALSE to friendly text
    in_streef = ifelse(in_streef, "streef", "laag/hoog"),
    # Optional: format numbers nicely
    Analyse_resultaat = round(Analyse_resultaat, 1),
    score = round(score, 2)
  )

# 2) Build the kableExtra table
kable_df %>%
  kable("latex", booktabs = TRUE, caption = "ANALYSERESULTATEN", escape = FALSE) %>%
  kable_styling(latex_options = c("striped", "hold_position", "scale_down")) %>%
  # Add column groups (spanners)
  add_header_above(c(" " = 1, "Waardering" = 2, " " = 2)) %>%
  # Color the 'Binnen streef?' column
  row_spec(
    1:nrow(kable_df),
    color = ifelse(kable_df$in_streef == "streef", "black", "black"),
    background = ifelse(kable_df$in_streef == "streef", "#009E73", "#D55E00")
  ) %>%
  # Optional: bold the Parameter column
  column_spec(1, bold = TRUE)

```


```{r}


# Define which FieldID you want to highlight
highlight_id <- params$FieldID  # e.g., "MC003"

highlight_id <- "MC003"

plot_df <- merged_df %>%
  mutate(
    highlight = case_when(
      is.na(FieldID) ~ "Missing",                      # optional: color for NA FieldID
      FieldID == highlight_id ~ "Selected farmer",
      TRUE ~ "Other"
    )
  )

ggplot(plot_df, aes(x = "", y = Plastig_kg)) +
  # Boxplot of all measurements together (no x labels)
  geom_boxplot(size = 1.5, width = 0.25, outlier.shape = NA) +
  
  
  
  # Colors: selected farmer in orange; others in grey; missing in darker grey
  scale_color_manual(
    values = c(
      "Selected farmer" = "red",
      "Other"           = "grey60",
      "Missing"         = "grey30"
    )
  ) +
  
  # Cloud of individual points; jitter a bit horizontally to see them
  geom_jitter(
    aes(color = highlight),
    width = 0.08, height = 0, size = 2, alpha = 0.70
  ) +
  
  labs(
    x = "",
    y = "Microplastics [kg per kg droge grond]",
    title = paste("Microplastics – alle metingen; highlight veld:", highlight_id),
    color = NULL
  ) +
  
  theme(
    axis.text.x  = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold"),
    plot.title   = element_text(face = "bold"),
    legend.position = "none"  # set to "right" if you want to show the legend
  ) +
  
  ylim(-1, NA)



```

```{r}


highlight_id <- "MC003"

plot_df <- merged_df %>%
  mutate(
    highlight = case_when(
      is.na(FieldID) ~ "Missing",
      FieldID == highlight_id ~ "Selected farmer",
      TRUE ~ "Other"
    ),
    highlight = factor(highlight, levels = c("Selected farmer", "Other", "Missing"))
  )

# Subset for the highlighted farmer
highlight_df <- plot_df %>% filter(highlight == "Selected farmer")

ggplot(plot_df, aes(x = "", y = Plastig_kg)) +
  # 1) Boxplot (all data)
  geom_boxplot(size = 1.5, width = 0.25, outlier.shape = NA) +
  
  # 2) Grey cloud (drawn FIRST so it stays behind)
  geom_jitter(
    data = plot_df %>% filter(highlight != "Selected farmer"),
    aes(color = highlight),
    width = 0.08, height = 0,
    size = 2, alpha = 0.6
  ) +
  
  # 3) Highlighted points (drawn AFTER to be on top, bigger size)
  geom_jitter(
    data = highlight_df,
    aes(color = highlight),
    width = 0.04, height = 0,
    size = 3.8, alpha = 0.95
  ) +
  
  # 4) Text labels for highlighted points
  geom_text(
    data = highlight_df,
    aes(label = scales::number(Plastig_kg, accuracy = 1)), # e.g., 0.123
    nudge_x = 0.12, nudge_y = 0,     # move labels slightly to the right of the point
    size = 3.4,
    fontface = "bold",
    color = "#d95f02"
  ) +
  
  scale_color_manual(
    values = c("Selected farmer" = "#d95f02", "Other" = "grey60", "Missing" = "grey30")
  ) +
  coord_cartesian(ylim = c(-1, NA)) +
  labs(
    x = "",
    y = "Microplastics [kg per kg droge grond]",
    title = paste("Microplastics – alle metingen; highlight veld:", highlight_id),
    color = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x  = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold"),
    plot.title   = element_text(face = "bold"),
    legend.position = "none"
  )

```

#Zoom in
```{r}

library(patchwork)  


p_full <- ggplot(plot_df, aes(x = "", y = Plastig_kg)) +
  geom_boxplot(width = 0.25, outlier.shape = NA) +
  geom_jitter(aes(color = highlight), width = 0.08, height = 0, size = 2, alpha = 0.6) +
  scale_color_manual(values = c("Selected farmer" = "#d95f02", "Other" = "grey60", "Missing" = "grey30")) +
  labs(x = "", y = "Microplastics [kg/kg] — volledige schaal") +
  theme_minimal() + theme(legend.position = "none")

p_zoom <- p_full + coord_cartesian(ylim = c(0, 200000)) +
  labs(y = "Microplastics [kg/kg] — zoom 0–1.000")

p_full / p_zoom  # stack vertically (use p_full | p_zoom for side-by-side)

```


